- name: Configure Web Server
  hosts: localhost
  connection: local
  become: yes

  tasks:
    # 1. Install Nginx using the special Amazon Linux Extras command
    - name: Install Nginx (Amazon Linux Extras)
      shell: "amazon-linux-extras install nginx1 -y"

    # 2. Install OpenSSL (Required for generating certificates)
    - name: Install OpenSSL
      yum:
        name: openssl
        state: present

    # 3. Generate a Self-Signed SSL Certificate
    - name: Generate Self-Signed SSL Certificate
      command: >
        openssl req -x509 -nodes -days 365 -newkey rsa:2048
        -keyout /etc/pki/tls/private/nginx-selfsigned.key
        -out /etc/pki/tls/certs/nginx-selfsigned.crt
        -subj "/C=EG/ST=Giza/L=Cairo/O=DevOps/CN=localhost"
      args:
        creates: /etc/pki/tls/certs/nginx-selfsigned.crt

    # 4. Configure Nginx to listen on Port 443 (HTTPS)
    - name: Configure Nginx for HTTPS
      copy:
        content: |
          server {
              listen 80;
              listen 443 ssl;
              server_name localhost;

              ssl_certificate /etc/pki/tls/certs/nginx-selfsigned.crt;
              ssl_certificate_key /etc/pki/tls/private/nginx-selfsigned.key;

              location / {
                  root /usr/share/nginx/html;
                  index index.html index.htm;
              }
          }
        dest: /etc/nginx/conf.d/ssl.conf
      notify: Restart Nginx

    # 5. Start Nginx Service
    - name: Start Nginx Service
      service:
        name: nginx
        state: started
        enabled: yes

    # 6. Create Your Custom Stylish Hello World Page
    - name: Create Stylish Hello World Page
      copy:
        dest: /usr/share/nginx/html/index.html
        content: |
          <!DOCTYPE html>
          <html>
          <head>
            <title>Welcome</title>
            <style>
              body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                height: 100vh;
                margin: 0;
                display: flex;
                align-items: center;
                justify-content: center;
              }
              .card {
                background: white;
                padding: 40px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                text-align: center;
                max-width: 500px;
              }
              h1 {
                color: #2d3748;
                margin-bottom: 10px;
                font-size: 28px;
              }
              .subtitle {
                color: #718096;
                font-size: 18px;
                margin-bottom: 20px;
              }
              .badge {
                display: inline-block;
                background-color: #EE0000; /* Ansible Red */
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-weight: bold;
                margin-top: 15px;
              }
            </style>
          </head>
          <body>
            <div class="card">
              <h1>Welcome Eng. Omar Heggy</h1>
              <p class="subtitle">I am <strong>Bahi</strong></p>
              <div class="badge">Terraform + I am also using Ansible!</div>
            </div>
          </body>
          </html>

  # Handler to restart Nginx if the SSL config changes
  handlers:
    - name: Restart Nginx
      service:
        name: nginx
        state: restarted